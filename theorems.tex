%Modified from Evan's evan.sty.
%
%Boost Software License - Version 1.0 - August 17th, 2003
%
%Permission is hereby granted, free of charge, to any person or organization
%obtaining a copy of the software and accompanying documentation covered by
%this license (the "Software") to use, reproduce, display, distribute,
%execute, and transmit the Software, and to prepare derivative works of the
%Software, and to permit third-parties to whom the Software is furnished to
%do so, all subject to the following:

%The copyright notices in the Software and this entire statement, including
%the above license grant, this restriction and the following disclaimer,
%must be included in all copies of the Software, in whole or in part, and
%all derivative works of the Software, unless such copies or derivative
%works are solely in the form of machine-executable object code generated by
%a source language processor.

%THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
%IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
%FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
%SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
%FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
%ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
%DEALINGS IN THE SOFTWARE.



\usepackage{amsthm}
\usepackage{thmtools}

\usepackage[framemethod=TikZ]{mdframed}
\usetikzlibrary{shadows}
% https://tex.stackexchange.com/a/292090/76888
% https://github.com/marcodaniel/mdframed/issues/12
\xpatchcmd{\endmdframed}
{\aftergroup\endmdf@trivlist\color@endgroup}
{\endmdf@trivlist\color@endgroup\@doendpe}
{}{}

\mdfdefinestyle{mdbluebox}{%
    roundcorner=1pt,
    linewidth=1pt,
    skipabove=12pt,
    skipbelow=7pt,
    innertopmargin=12pt,
    innerbottommargin=9pt,
    linecolor=RoyalBlue!35,
    nobreak=true,
    backgroundcolor=RoyalBlue!4,
    shadow=true,
    shadowsize=4.7pt,
    shadowcolor=black!30,
}
\declaretheoremstyle[
headfont=\sffamily\bfseries\color{RoyalBlue},
mdframed={style=mdbluebox},
headpunct={\\[2pt]},
postheadspace={0pt},
postheadhook={\textcolor{RoyalBlue!60}{\rule[.6ex]{\textwidth}{0.4pt}} \\ }, % \\ removed
bodyfont=\itshape,
]{thmbluebox}

\mdfdefinestyle{mdredbox}{%
    skipbelow=2pt,
    skipabove=8pt,
    linewidth=2pt,
    innertopmargin=12pt,
    innerbottommargin=5pt,
    rightline=false,
    leftline=true,
    topline=false,
    bottomline=false,
    linecolor=black,
    backgroundcolor=gray!1,
}
\declaretheoremstyle[
headfont=\bfseries\sffamily,
mdframed={style=mdredbox},
]{thmredbox}

\mdfdefinestyle{mdgreenbox}{%
    skipbelow=0pt,
    skipabove=8pt,
    linewidth=2pt,
    innertopmargin=12pt,
    innerbottommargin=9pt,
    rightline=false,
    leftline=true,
    topline=false,
    bottomline=false,
    linecolor=ForestGreen,
    backgroundcolor=ForestGreen!2,
}
\declaretheoremstyle[
headfont=\bfseries\sffamily\color{ForestGreen},
bodyfont=\normalfont,
postheadspace={0pt},
mdframed={style=mdgreenbox},
headpunct={ --- },
]{thmgreenbox}

\mdfdefinestyle{mdblackbox}{%
    skipabove=8pt,
    linewidth=3pt,
    rightline=false,
    leftline=true,
    innertopmargin=12pt,
    innerbottommargin=9pt,
    topline=false,
    bottomline=false,
    linecolor=black,
    backgroundcolor=RedViolet!5!gray!5,
}
\declaretheoremstyle[
headfont=\sffamily\bfseries,
bodyfont=\sffamily\small,
spaceabove=2pt,
spacebelow=0pt,
mdframed={style=mdblackbox}
]{thmblackbox}

\mdfdefinestyle{mdpurplebox}{%
    roundcorner=1pt,
    linewidth=1pt,
    skipabove=12pt,
    skipbelow=7pt,
    innertopmargin=12pt,
    innerbottommargin=9pt,
    linecolor=Orchid!35,
    nobreak=true,
    backgroundcolor=Orchid!10,
    shadow=true,
    shadowsize=4pt,
    shadowcolor=black!30,
}
\declaretheoremstyle[
headfont=\sffamily\bfseries\color{Orchid},
mdframed={style=mdpurplebox},
headpunct={\\[2pt]},
postheadspace={0pt},
postheadhook={\textcolor{Orchid!80}{\rule[.6ex]{\textwidth}{0.4pt}} \\ }, % \\ removed
]{thmpurplebox}
\newcommand{\listhack}{$\empty$\vspace{-2em}}


\mdfdefinestyle{mdsiennamargin}{%
    skipabove=8pt,
    linewidth=2pt,
    leftline=true,
    rightline=false,
    bottomline=false,
    topline=false,
    linecolor=RoyalBlue,
    backgroundcolor=RoyalBlue!2,
}
\declaretheoremstyle[
headfont=\bfseries\rmfamily\color{purple},
postheadspace={0pt},
mdframed={style=mdsiennamargin},
headpunct={ \\[3pt] },
]{thmmarginbox}

\mdfdefinestyle{mdgreymargin}{%
    skipabove=20pt,
    linewidth=2pt,
    leftline=true,
    rightline=false,
    bottomline=false,
    topline=false,
    linecolor=JungleGreen,
    backgroundcolor=JungleGreen!4,
}
\declaretheoremstyle[
headfont=\bfseries\rmfamily\color{purple},
postheadspace={0pt},
mdframed={style=mdgreymargin},
headpunct={ \\[3pt] },
]{thmmarginref}

\mdfdefinestyle{mdthmbox}{%
    roundcorner=4pt,
    linewidth=1pt,
    skipabove=12pt,
    skipbelow=7pt,
    innertopmargin=9pt,
    nobreak=true,
    innerbottommargin=9pt,
}

\usepackage{ifoddpage}

\newlength{\spaceblength}
\settowidth{\spaceblength}{\bfseries\ }
\declaretheoremstyle[
    headfont=\bfseries,
    notefont=\scshape,
    notebraces={}{\\[\parskip]}, % Braces for additional text
    bodyfont=\normalfont\itshape,
    mdframed={style=mdthmbox},
    headpunct={},
    headformat={%
        \checkoddpage\ifoddpage\rlap{\hskip\textwidth\hspace*{2ex}\small\sffamily\color{black}\ \ \ \NAME\ \NUMBER}\hskip-\spaceblength{\NOTE}%
        \else\rlap{\hskip\textwidth\hspace*{2ex}\small\sffamily\color{black}\ \ \ \NAME\ \NUMBER}\hskip-\spaceblength{\NOTE}\fi%
    },
]{boxstyle}

\mdfdefinestyle{blackbox}{%
    frametitlerulewidth=1pt,
    frametitlerule=true,
    roundcorner=4pt,
    linewidth=1pt,
    skipabove=15pt,
    skipbelow=2pt,
    frametitlefont=\bfseries,
    innertopmargin=12pt,
    innerbottommargin=8pt,
    nobreak=false,
    backgroundcolor=gray!2,
    linecolor=black,
}

\mdfdefinestyle{remarkbox}{%
    frametitlerule=false,
    roundcorner=4pt,
    linewidth=1pt,
    skipabove=15pt,
    skipbelow=2pt,
    frametitlefont=\itshape,
    innertopmargin=12pt,
    innerbottommargin=8pt,
    nobreak=true,
    backgroundcolor=white,
    linecolor=black,
}


\patchcmd{\endproof}% <cmd>
  {\endtrivlist}% <search>
  {\endtrivlist\par\nobreak\vspace*{\dimexpr-\baselineskip-\parskip}\nobreak\noindent\hrulefill}% <replace>
  {}{}% <succes><failure>

\mdtheorem[style=remarkbox]{remark}[subsection]{Remark}


\declaretheorem[style=thmredbox,name=Example,numberwithin=section]{example}
\declaretheorem[style=boxstyle,name=Theorem,numberwithin=chapter]{theorem}


\declaretheorem[style=boxstyle,name=Theorem,numbered=no]{theorem*}
\declaretheorem[style=boxstyle,name=Lemma,numbered=no]{lemma*}
\declaretheorem[style=boxstyle,name=Lemma,sibling=theorem]{lemma}


\declaretheorem[style=basehead,name=Proposition,numbered=no]{proposition*}
\declaretheorem[style=thmgreenbox,name=Corollary,numbered=no]{corollary*}
\declaretheorem[style=thmgreenbox,name=Assumption,numbered=no]{assume*}
\declaretheorem[style=basehead,name=Proposition,sibling=theorem]{proposition}
\declaretheorem[style=thmgreenbox,name=Corollary,sibling=theorem]{corollary}
\declaretheorem[style=thmgreenbox,name=Assumption,sibling=theorem]{assume}
\declaretheorem[style=thmgreenbox,name=Algorithm,sibling=theorem]{algorithm}
\declaretheorem[style=thmgreenbox,name=Algorithm,numbered=no]{algorithm*}
\declaretheorem[style=thmgreenbox,name=Claim,sibling=theorem]{claim}
\declaretheorem[style=thmgreenbox,name=Claim,numbered=no]{claim*}

% Remark-style theorems
\declaretheorem[style=thmblackbox,name=Problem,numbered=no]{problem*}
\declaretheorem[style=thmblackbox,name=Question,sibling=theorem]{ques}


\declaretheorem[style=thmmarginbox,name=\begingroup\color{RoyalBlue}\blacktriangleright\endgroup,numbered=no]{marginnotebox}
\declaretheorem[style=thmmarginref,name=\begingroup\color{JungleGreen}\blacksquare\endgroup,numbered=no]{marginrefbox}

\declaretheoremstyle[spaceabove=6pt,spacebelow=6pt, bodyfont=\em,]{basehead}

\declaretheorem[style=basehead,name=Answer,sibling=theorem]{answer}
\declaretheorem[style=basehead,name=Answer,numbered=no]{answer*}
\declaretheorem[style=basehead,name=Proposition,sibling=theorem]{plainprop}
\declaretheorem[style=basehead,name=Proposition,numbered=no]{plainprop*}
\declaretheorem[style=basehead,name=Theorem,sibling=theorem]{plaintheo}
\declaretheorem[style=basehead,name=Theorem,numbered=no]{plaintheo*}
\declaretheorem[style=basehead,name=Lemma,sibling=theorem]{plainlem}
\declaretheorem[style=basehead,name=Lemma,numbered=no]{plainlem*}


\declaretheorem[style=thmpurplebox,name=Conjecture,sibling=theorem]{conjecture}
\declaretheorem[style=thmpurplebox,name=Conjecture,numbered=no]{conjecture*}
\declaretheorem[style=boxstyle,name=Definition,sibling=theorem]{definition}
\declaretheorem[style=boxstyle,name=Definition,numbered=no]{definition*}

\declaretheorem[style=basehead,name=Fact,sibling=theorem]{fact}
\declaretheorem[style=basehead,name=Fact,numbered=no]{fact*}
\declaretheorem[style=basehead,name=Problem,sibling=theorem]{problem}
\declaretheorem[style=basehead,name=Question,numbered=no]{ques*}

\Crefname{answer}{Answer}{Answers}
\Crefname{assume}{Assumption}{Assumptions}
\Crefname{claim}{Claim}{Claims}
\Crefname{conjecture}{Conjecture}{Conjectures}
\Crefname{exercise}{Exercise}{Exercises}
\Crefname{fact}{Fact}{Facts}
\Crefname{problem}{Problem}{Problems}
\Crefname{ques}{Question}{Questions}

\newcommand{\motiv}[1]{
    \emph{{\color{red} Motivation:} #1} \par\medskip
}
\newenvironment{moral}{%
    \begin{mdframed}[linecolor=green!70!black]%
        \bfseries\color{green!50!black}}%
    {\end{mdframed}}


\usepackage{xsim, needspace}


\makeatletter
\DeclareExerciseEnvironmentTemplate{custom}{%
  \par\vspace{3.25ex plus 1ex minus .2ex}
  \Needspace*{3\baselineskip}%
  \noindent\normalsize
  \textcolor{black}{%
    \textbf{\XSIMmixedcase{\GetExerciseName}\nobreakspace\GetExerciseProperty{counter}}%
  }%
  \IfInsideSolutionF{%
    \GetExercisePropertyT{subtitle}{ {\normalfont\itshape\PropertyValue}}%
  }%
  \normalsize
  \GetExercisePropertyT{points}{%
    \marginpar{%
        [{\color{TealBlue}\printgoal{\PropertyValue}}]%
        \GetExercisePropertyT{bonus-points}{~[+\printgoal{\PropertyValue}]}%
    }%
  }%
  \;
  \@afterindentfalse\@afterheading
}
{}
\makeatother

\xsimsetup{
  exercise/the-counter = \arabic{exercise}. ,
  exercise/template = custom ,
  solution/template = custom ,
  exercise/name =  \triangleright
}

\newenvironment{exc}{%
    ~\\ \rule[0cm]{\textwidth-4cm}{0.01cm}\rule[-0.11cm]{4cm}{0.12cm} \vskip2pt {\hspace*{\textwidth-3.8cm}\Large\textbf{Exercises}}}%
    {~\\ \hrule ~\\}
